name: Deploy PL/SQL to OCI Autonomous DB

on:
  push:
    branches: [ "main" ]

    # Auth env for Oracle's action (as documented in the repo)
env:
  OCI_CLI_USER:        ${{ secrets.OCI_USER_OCID }}
  OCI_CLI_TENANCY:     ${{ secrets.OCI_TENANCY_OCID }}
  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}   # full PEM with headers/footers
  OCI_CLI_REGION:      ${{ secrets.OCI_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Make ADB-specific values available as env so we can embed them with ${{ env.* }}
    env:
      ATP_OCID:        ${{ secrets.ATP_OCID }}
      WALLET_PASSWORD: ${{ secrets.WALLET_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show OCI CLI version
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: oci --version
          silent: false

      - name: Verify auth (Object Storage namespace)
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: oci os ns get
          silent: false

      #Use ${{ env.ATP_OCID }} and ${{ env.WALLET_PASSWORD }} so the values are injected
      - name: Show ADB details (sanity check)
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: >
            oci db autonomous-database get
            --autonomous-database-id ${{ env.ATP_OCID }}
            --region ${{ env.OCI_CLI_REGION }}
            --debug
          silent: false

      - name: Download Autonomous DB Wallet
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: >
            oci db autonomous-database generate-wallet
            --autonomous-database-id ${{ env.ATP_OCID }}
            --password '${{ env.WALLET_PASSWORD }}'
            --file wallet.zip
            --generate-type SINGLE
            --region ${{ env.OCI_CLI_REGION }}
            --debug
          silent: false

      - name: Unzip wallet
        run: unzip -o wallet.zip -d wallet

      - name: Install SQLcl
        run: |
          set -e
          curl -sS -O https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip
          unzip -q sqlcl-latest.zip -d $HOME/sqlcl
          echo "$HOME/sqlcl/sqlcl/bin" >> $GITHUB_PATH
      
      - name: Inspect wallet files
        run: |
          echo "Wallet directory contents:"
          ls -R wallet || echo "wallet directory missing"

      - name: Check wallet.zip
        run: |
          echo "Wallet zip size:"
          ls -l wallet.zip

      - name: Run PL/SQL scripts
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_SERVICE:  ${{ secrets.DB_SERVICE }}
        run: |
          sql /nolog <<'EOF'
          SET ECHO ON FEEDBACK ON SERVEROUTPUT ON
          SET CLOUDCONFIG wallet
          SHOW TNS
          SET ECHO ON FEEDBACK ON SERVEROUTPUT ON
          CONNECT GITWORKFLOWTEST/${DB_PASSWORD}@wallet/${DB_SERVICE}
          EXIT
          EOF
          EXIT
          EOF
