name: Nightly Schema Export

on:
    workflow_dispatch:       # allow manual run

permissions:
  contents: write          # required to commit back with GITHUB_TOKEN

    # Auth env for Oracle's action (as documented in the repo)
env:
  OCI_CLI_USER:        ${{ secrets.OCI_USER_OCID }}
  OCI_CLI_TENANCY:     ${{ secrets.OCI_TENANCY_OCID }}
  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}   # full PEM with headers/footers
  OCI_CLI_REGION:      ${{ secrets.OCI_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Make ADB-specific values available as env so we can embed them with ${{ env.* }}
    env:
      ATP_OCID:        ${{ secrets.ATP_OCID }}
      WALLET_PASSWORD: ${{ secrets.WALLET_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show OCI CLI version
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: oci --version
          silent: true

      - name: Verify auth (Object Storage namespace)
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: oci os ns get
          silent: true

      - name: Download Autonomous DB Wallet
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        with:
          command: >
            oci db autonomous-database generate-wallet
            --autonomous-database-id ${{ env.ATP_OCID }}
            --password '${{ env.WALLET_PASSWORD }}'
            --file wallet.zip
            --generate-type SINGLE
            --region ${{ env.OCI_CLI_REGION }}
            --debug
          silent: true

      - name: Unzip wallet
        run: unzip -o wallet.zip -d wallet

      - name: Install SQLcl
        run: |
          set -e
          curl -sS -O https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip
          unzip -q sqlcl-latest.zip -d $HOME/sqlcl
          echo "$HOME/sqlcl/sqlcl/bin" >> $GITHUB_PATH
      

      - name: Install Java
        uses: graalvm/setup-graalvm@v1
        with:
         version: '22.3.1'
         java-version: '17'
         components: 'js'


      - name: Test SQLcl JS engine
        run: |
            sql /nolog <<EOF
            script
            ctx.write("JS engine is working!\n");
            /
            EXIT
            EOF

      - name: Export Schema
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_SERVICE:  ${{ secrets.DB_SERVICE }}   # e.g., apxedev_tp
          EXPORT_SCHEMA: WKSP_PENSIONCALC
        run: |
          set -e
          JS_FILE="$GITHUB_WORKSPACE/tools/export_schema.js"
          # Point SQLcl at the wallet directory so it can read tnsnames.ora/sqlnet.ora
          export TNS_ADMIN="$GITHUB_WORKSPACE/wallet"
          echo "Using TNS_ADMIN=$TNS_ADMIN"

          # Run SQLcl and let the shell expand env variables (notgt e: no quotes around EOF)
          sql /nolog <<EOF
          SET ECHO ON FEEDBACK ON SERVEROUTPUT ON
          WHENEVER SQLERROR EXIT SQL.SQLCODE
          CONNECT GITWORKFLOWTEST/"$DB_PASSWORD"@$DB_SERVICE
          script ${JS_FILE}
          EXIT
          EOF



      - name: Commit & push if changed
        run: |
          set -e
          git config user.name  "github-actions"
          git config user.email "actions@github.com"
          git add schema_export || true
          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Nightly schema export: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "No schema changes to commit."
          fi